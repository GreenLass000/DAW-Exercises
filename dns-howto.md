# DNS

## Instalación 

Lo primero que hay que hacer siempre es actualizar las dependencias

```bash
apt update
```

Instala dns `bind9` y programas extras `dnsutils`

```bash
apt install bind9 dnsutils
```

Para comprobar la sintaxis de los archivos de configuración de bind9

```bash
# Puedes especificar un archivo que quieras comprobar
named-checkconf [fichero]
# Si se pone vacío compruena named.conf junto a sus imports
named-checkconf
```

## Configuración

Cambiar `/etc/resolv.conf` 
```
nameserver 127.0.0.1
```
Escribir el siguiente comando para que al reiniciar no se sobreescriba
```bash
chattr +i /etc/resolv.conf
```
Para poder editar el archivo hay que desbloquearlo
```bash
chattr -i /etc/resolv.conf
```

Configurar los forwarders para añadir la ip en el archivo `/etc/bind/named.conf.options`
Hay que añadir la línea `auth-nxdomain no`
```
options {
        directory "/var/cache/bind";

        // If there is a firewall between you and nameservers you want
        // to talk to, you may need to fix the firewall to allow multiple
        // ports to talk.  See http://www.kb.cert.org/vuls/id/800113

        // If your ISP provided one or more IP addresses for stable
        // nameservers, you probably want to use them as forwarders.
        // Uncomment the following block, and insert the addresses replacing
        // the all-0's placeholder.

        forwarders {
                127.0.1.1;
        //      1.1.1.1;
        //      8.8.8.8;
        };

        //========================================================================
        // If BIND logs error messages about the root key being expired,
        // you will need to update your keys.  See https://www.isc.org/bind-keys
        //========================================================================

        //dnssec-validation auto;

        auth-nxdomain no;
        listen-on-v6 { any; };
};
```

Configurar la zona directa en el archivo `/etc/bind/named.conf.local`
```
//
// Do any local configuration here
//

// Consider adding the 1918 zones here, if they are not used in your 
// organization
//include "/etc/bind/zones.rfc1918";

zone "[nombre]" { 
        type master;
        file "/etc/bind/db.[nombre]";
        allow-query { any; };
};
```

Y crear archivo de zona directa `/etc/bind/db.[nombre]`
```
;
; archivo BIND para zona [name]
;
$TTL    604800
@       IN      SOA     [name].        hostmaster.[name].    (
                1               ; Serial
                86400           ; Refresh
                7200            ; Retry
                1209600         ; Expire
                10800 )         ; Negative Cache TTL

[name].         IN      NS      ns1.a01.com.
[name].         IN      MX      1        ns1.[name].
[name].         IN      A       27.0.175.226
ns1             IN      A       27.0.175.226
www             IN      A       127.0.0.1
#smtp           IN      A       127.0.0.1

status          IN      CNAME   [ddns hostname].
```

Se puede comprobar si el dns funciona correctamente con `dig`
```bash
dig www.a01.com
```
```
; <<>> DiG 9.16.44-Debian <<>> www.a01.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 28189
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 8c66e500c14cd13d01000000655a5e6a7a3e679851f1b4bb (good)
;; QUESTION SECTION:
;www.a01.com.                   IN      A

;; ANSWER SECTION:
www.a01.com.            604800  IN      A       127.0.0.1        

;; Query time: 0 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Sun Nov 19 20:13:46 CET 2023
;; MSG SIZE  rcvd: 84
```

## DDNS

Para configurar un ddns hay que instalar el cliente de un servicio ddns

```bash
apt install ddclient
```
Seguir todos los pasos que aparecen en pantalla

Se puede cambiar la configuración desde `/etc/ddclient.conf`
```
# Configuration file for ddclient generated by debconf
#
# /etc/ddclient.conf

protocol=noip \
use=web, web=http://ip1.dynupdate.no-ip.com/ \
login=[usuario] \
password=[contraseña] \
[ddns hostname]
```

Hay que reiniciar los servicios de `bind9` y `ddclient`
```bash
systemctl restart bind9
```
```bash
systemctl restart ddclient
```

Para comprobarlo desde otra maquina, hay que poner en dns en el archivo `/etc/resolv.conf`
```
nameserver 27.0.175.226
```
Y probamos que funcione con `nslookup`
```bash
nslookup www.a01.com
```
```
Server:		27.0.175.226
Address:	27.0.175.226#53

Name:	www.a01.com
Address: 127.0.0.1
```
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTEwODkyMTk2NDFdfQ==
-->